---
- name: Deploy Factorio server
  hosts: localhost
  vars:
    terraform_directory: "{{ playbook_dir }}/terraform"
  vars_files:
    - vars/factorio.yml

  roles:
    - server_init

  tasks:
    - name: Wait for server to come online
      ansible.builtin.wait_for:
        host: "{{ factorio_ipv4.stdout }}"
        port: 22
        delay: 10

    - name: Refresh Ansible inventory
      ansible.builtin.meta: "refresh_inventory"

- name: Setup Factorio server
  hosts: ansible_managed_vm
  remote_user: root
  vars_files:
    - vars/factorio.yml
  roles:
    - factorio_init
